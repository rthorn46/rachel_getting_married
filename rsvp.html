<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RSVP - Rachel & Cameron</title>
  <style>
    body { font-family: Georgia, serif; background-color: #f7f3ed; color: #4a3728; text-align: center; padding: 40px; }
    input, button { padding: 10px; margin: 10px; font-size: 16px; }
    .hidden { display: none; }
    form { margin-top: 20px; }
  </style>
</head>
<body>

<h1>RSVP</h1>

<div id="lookup">
  <p>Enter your invite code:</p>
  <input type="text" id="inviteCode" placeholder="Invite Code">
  <button onclick="lookupInvite()">Find Invite</button>
</div>

<form id="rsvpForm" class="hidden" onsubmit="submitRSVP(event)">
  <div id="nameDisplay"></div>

  <div id="rehearsalSection" class="hidden">
    <p>Will you attend the Rehearsal Dinner?</p>
    <label><input type="radio" name="attending_rehearsal" value="true"> Yes</label>
    <label><input type="radio" name="attending_rehearsal" value="false"> No</label>
  </div>

  <div id="weddingSection" class="hidden">
    <p>Will you attend the Wedding?</p>
    <label><input type="radio" name="attending_wedding" value="true"> Yes</label>
    <label><input type="radio" name="attending_wedding" value="false"> No</label>
  </div>

  <div id="plusOneSection" class="hidden">
    <p>Plus One Name:</p>
    <input type="text" id="plusOneName" placeholder="Full Name">
  </div>

  <button type="submit">Submit RSVP</button>
</form>

<div id="successMessage" class="hidden">
  <h2>Thank you for RSVPing!</h2>
  <button onclick="editRSVP()">Edit RSVP</button>
</div>

<script>
const supabaseUrl = 'https://wftugsoynahkvuwjyzok.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmdHVnc295bmFoa3Z1d2p5em9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4MDcwNzksImV4cCI6MjA2MTM4MzA3OX0._8lsuDcxHJibDnjh5Zn4RCHDQ4cKCn7OvEDBtidJ8D0';
const tableName = 'invites';

async function lookupInvite() {
  const code = document.getElementById('inviteCode').value.trim().toLowerCase();
  console.log('Looking up invite with code:', code);

  try {
    const response = await fetch(`${supabaseUrl}/rest/v1/${tableName}?select=*&code=eq.${encodeURIComponent(code)}`, {
      headers: {
        'apikey': supabaseKey,
        'Authorization': `Bearer ${supabaseKey}`,
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }
    });
    console.log('Response status:', response.status);
    const data = await response.json();
    console.log('Fetched data:', data);

    if (!data || data.length === 0) {
      alert('Invite not found.');
      return;
    }

    const invite = data[0];

    document.getElementById('lookup').classList.add('hidden');
    document.getElementById('rsvpForm').classList.remove('hidden');

    document.getElementById('nameDisplay').innerHTML = `<h2>Hello, ${invite.name}!</h2>`;

    if (invite.rehearsal_invite) {
      document.getElementById('rehearsalSection').classList.remove('hidden');
      if (invite.attending_rehearsal !== null) {
        document.querySelector(`input[name="attending_rehearsal"][value="${invite.attending_rehearsal}"]`).checked = true;
      }
    }
    if (invite.wedding_invite) {
      document.getElementById('weddingSection').classList.remove('hidden');
      if (invite.attending_wedding !== null) {
        document.querySelector(`input[name="attending_wedding"][value="${invite.attending_wedding}"]`).checked = true;
      }
    }
    if (invite.has_plus_one) {
      document.getElementById('plusOneSection').classList.remove('hidden');
      if (invite.plus_one_name) {
        document.getElementById('plusOneName').value = invite.plus_one_name;
      }
    }

    window.currentInvite = invite; // Save for later
  } catch (error) {
    console.error('Lookup error:', error);
    alert('Error looking up invite.');
  }
}

async function submitRSVP(event) {
  event.preventDefault();

  const rehearsalAnswer = document.querySelector('input[name="attending_rehearsal"]:checked')?.value;
  const weddingAnswer = document.querySelector('input[name="attending_wedding"]:checked')?.value;
  const plusOneName = document.getElementById('plusOneName').value.trim();

  const updates = {
    attending_rehearsal: rehearsalAnswer === 'true' ? true : (rehearsalAnswer === 'false' ? false : null),
    attending_wedding: weddingAnswer === 'true' ? true : (weddingAnswer === 'false' ? false : null),
    plus_one_name: plusOneName || null
  };

  console.log('Submitting updates:', updates);

  try {
    const response = await fetch(`${supabaseUrl}/rest/v1/${tableName}?id=eq.${window.currentInvite.id}`, {
      method: 'PATCH',
      headers: {
        'apikey': supabaseKey,
        'Authorization': `Bearer ${supabaseKey}`,
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify(updates)
    });
    console.log('Submit response status:', response.status);
    const result = await response.json();
    console.log('Submit result:', result);

    if (response.status >= 400) {
      console.error('RSVP Error:', result);
      alert('Something went wrong!');
      return;
    }

    document.getElementById('rsvpForm').classList.add('hidden');
    document.getElementById('successMessage').classList.remove('hidden');
  } catch (error) {
    console.error('RSVP error:', error);
    alert('Error submitting RSVP.');
  }
}

function editRSVP() {
  document.getElementById('successMessage').classList.add('hidden');
  document.getElementById('rsvpForm').classList.remove('hidden');
}
</script>

</body>
</html>
